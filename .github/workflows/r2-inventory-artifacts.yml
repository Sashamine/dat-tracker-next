name: R2 Inventory → D1 Artifacts Backfill

on:
  workflow_dispatch:
    inputs:
      r2_bucket:
        description: R2 bucket name to inventory
        required: true
        default: dat-tracker-filings
      r2_prefix:
        description: Optional prefix filter (e.g. "sec/", "dashboard/")
        required: false
        default: ""
      dry_run:
        description: If true, only report counts (no D1 writes)
        required: true
        default: "true"
      max_objects:
        description: Optional max objects to scan (0 = unlimited)
        required: true
        default: "2000"
      r2_list_limit:
        description: Page size for R2 list (max 1000)
        required: true
        default: "1000"
      cursor:
        description: Optional R2 list cursor/continuation token (from previous run output)
        required: false
        default: ""

jobs:
  inventory:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: R2 inventory → D1 artifacts backfill
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_D1_DATABASE_ID: ${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

          R2_BUCKET: ${{ inputs.r2_bucket }}
          R2_PREFIX: ${{ inputs.r2_prefix }}
          DRY_RUN: ${{ inputs.dry_run }}
          MAX_OBJECTS: ${{ inputs.max_objects }}
          R2_LIST_LIMIT: ${{ inputs.r2_list_limit }}
          R2_CURSOR: ${{ inputs.cursor }}

        run: npx tsx scripts/cloudflare/r2-inventory-to-d1-artifacts.ts
