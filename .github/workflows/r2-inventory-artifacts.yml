name: R2 Inventory → D1 Artifacts Backfill

on:
  workflow_dispatch:
    inputs:
      r2_bucket:
        description: R2 bucket name to inventory
        required: true
        default: dat-tracker-filings
      r2_prefix:
        description: Optional prefix filter (e.g. "sec/", "dashboard/")
        required: false
        default: ""
      dry_run:
        description: If true, only report counts (no D1 writes)
        required: true
        default: "true"
      max_objects:
        description: Optional max objects to scan (0 = unlimited)
        required: true
        default: "2000"
      r2_list_limit:
        description: Page size for R2 list (max 1000)
        required: true
        default: "1000"
      cursor:
        description: Optional R2 list cursor/continuation token (from previous run output)
        required: false
        default: ""
      start_after:
        description: S3 ListObjectsV2 start-after (fallback pagination). Used only when cursor is empty.
        required: false
        default: ""
      debug_pagination:
        description: Enable verbose pagination logs
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      delimiter:
        description: S3 delimiter for listing common prefixes (e.g. "/")
        required: false
        default: ""
      list_prefixes_only:
        description: If true, output common prefixes (requires delimiter) and exit
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      allow_empty_prefix:
        description: Allow running with an empty prefix (full-bucket scan). Keep false unless you intend that.
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

      verify_writes:
        description: If true, verify each write by checking row existence before/after (slower; use for debugging counters).
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  inventory:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: R2 inventory → D1 artifacts backfill
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_D1_DATABASE_ID: ${{ secrets.CLOUDFLARE_D1_DATABASE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_R2_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY_ID }}
          CLOUDFLARE_R2_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_R2_SECRET_ACCESS_KEY }}

          R2_BUCKET: ${{ inputs.r2_bucket }}
          R2_PREFIX: ${{ inputs.r2_prefix }}
          DRY_RUN: ${{ inputs.dry_run }}
          MAX_OBJECTS: ${{ inputs.max_objects }}
          R2_LIST_LIMIT: ${{ inputs.r2_list_limit }}
          R2_CURSOR: ${{ inputs.cursor }}
          R2_START_AFTER: ${{ inputs.start_after }}
          DEBUG_R2_PAGINATION: ${{ inputs.debug_pagination }}
          R2_DELIMITER: ${{ inputs.delimiter }}
          R2_LIST_PREFIXES_ONLY: ${{ inputs.list_prefixes_only }}

          # Guardrails / observability
          PROGRESS_EVERY: "500"
          MAX_ERRORS: "25"
          REQUIRE_PREFIX: "true"
          # Set to true explicitly when you intend a full bucket scan
          ALLOW_EMPTY_PREFIX: ${{ inputs.allow_empty_prefix }}
          # Optional throttling to avoid D1 rate limits
          D1_THROTTLE_MS: "0"

          # Debugging
          VERIFY_WRITES: ${{ inputs.verify_writes }}

        run: npx tsx scripts/cloudflare/r2-inventory-to-d1-artifacts.ts
